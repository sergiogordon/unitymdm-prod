Milestone Context & End Goal â€” Fix Replit Object Storage Authentication (APK Uploads & Downloads)

Purpose:
Restore functional, authenticated uploads and downloads to Replit Object Storage (App Storage) so your CI pipeline can register and upload APKs, and your devices can fetch them via /v1/apk/download-latest.
This milestone fixes the 401 Invalid Credentials error by re-establishing proper service authentication between your NexMDM backend and Replitâ€™s Google Cloud-backed storage layer.

ğŸ§© Why itâ€™s failing (summary)

Replitâ€™s get_storage_service() relies on the Replit sidecar to issue short-lived signed credentials for Google Cloud Storage.
Your current deployment is returning a dummy unsigned JWT (eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.e30.) â€” meaning the sidecar isnâ€™t actually connected to a provisioned service account or token exchange.
So, your backend canâ€™t authenticate when calling storage.upload_file() or storage.download_file().

âœ… What â€œdoneâ€ means

APK uploads from GitHub Actions â†’ POST /admin/apk/upload â†’ store successfully in Replit App Storage (no 401).

GET /v1/apk/download-latest for devices returns a valid signed download URL.

GET /admin/apk/download/{build_id} works in the UI (admin download).

Auth chain verified: backend â†” Replit sidecar â†” GCS bucket (replit-objstore-...).

CI job completes full artifact publishing (register + upload).

ğŸ”§ Implementation plan
1. Diagnose sidecar auth scope

Inspect current Replit environment:

Run inside your Replit shell:

echo $REPL_ID
echo $REPL_SLUG
cat /home/runner/.config/replit/replit.yaml | grep storage
env | grep REPLIT


Confirm your app has â€œApp Storageâ€ enabled in Replit â†’ Tools â†’ Storage.

Test credential fetch manually:

from replit import storage
storage.upload("test.txt", "hello world")


If it fails with the same 401 Invalid Credentials, the issue is global (sidecar misprovisioned).

âœ… Outcome: Confirm that the problem is infrastructure, not code.

2. Rebind storage credentials (Replit sidecar patch)

Delete and re-add the App Storage integration in the Replit UI:

Open your Replit project â†’ â€œToolsâ€ â†’ â€œStorageâ€.

Disable or remove existing object storage.

Re-enable it â€” this triggers Replit to re-provision a service account and connect your sidecar to the correct GCS bucket.

Redeploy the Replit environment (stop/start) so /run_sidecar picks up new credentials.

Verify by running:

from replit import storage
for key in storage.keys():
    print(key)


â†’ should list or return empty (not error).

âœ… Outcome: Replit regenerates valid signed tokens for GCS.

3. Update backend storage adapter

Create a thin wrapper storage_client.py to abstract backend storage calls:

from replit import storage
from io import BytesIO

class StorageClient:
    def upload(self, filename: str, data: bytes):
        storage[filename] = data
        return f"storage://{filename}"

    def download(self, filename: str) -> BytesIO:
        return BytesIO(storage[filename])

    def delete(self, filename: str):
        del storage[filename]


In get_storage_service(), replace direct GCS calls with this wrapper for the Replit environment.

Add an environment check:

if os.getenv("REPLIT_DEPLOYMENT") == "true":
    return StorageClient()  # uses replit.storage
else:
    return S3Client()  # fallback path for later


âœ… Outcome: Backend always uses Replitâ€™s native SDK when on Replit.

4. CI upload validation

In your GitHub Action, after the APK is built and registered, test upload:

curl -sS -X POST "$BASE_URL/admin/apk/upload" \
  -H "X-Admin: $ADMIN_KEY" \
  -F "file=@app-debug.apk"


Backend should return 200 { "url": "storage://Unity-v1.2.1.apk" }.

âœ… Outcome: Upload confirmed from CI â†’ Replit storage.

5. End-to-end OTA validation

Device calls GET /v1/apk/download-latest â†’ backend resolves storage://â€¦ â†’ calls Replit storage.get() â†’ returns signed download URL or stream.

Device successfully downloads and installs.

Confirm backend logs show:

apk.download {source=device, build_id=b_..., url=storage://...}


âœ… Outcome: OTA updates work again.

ğŸ§± Non-goals

No S3 migration or cross-cloud setup in this milestone.

No caching/CDN layer yet (handled later once storage stable).

No build versioning changes (handled via /admin/apk/register milestone).

ğŸ”’ Security & reliability

Replit storage tokens are short-lived and auto-refreshed by the sidecar â€” no manual keys.

Limit upload file types (.apk) and max size (e.g., 50 MB).

Add retry/backoff on transient 5xx errors from GCS.

Maintain local in-memory cache of last signed download URL (expires after 5 min).

ğŸ“Š Observability

Add structured logs:

storage.upload.start|success|error

storage.download.start|success|error

Metrics:

storage_uploads_total, storage_upload_errors_total, storage_latency_ms_bucket

âœ… Acceptance tests

POST /admin/apk/upload with 20 MB APK â†’ returns 200; file visible in Replit â€œApp Storage.â€

GET /admin/apk/download/{id} â†’ 200; downloads same size file.

CI job completes end-to-end without 401.

Device fetches /v1/apk/download-latest â†’ receives 200 + valid APK bytes.

If Replit sidecar restarts, uploads still work (credentials auto-refresh).

ğŸš€ Definition of Done

Replit sidecar properly issues signed GCS credentials.

NexMDM backend uploads/downloads APKs with no 401s.

CI pipeline publishes APKs end-to-end into App Storage.

OTA delivery restored across all enrolled devices.
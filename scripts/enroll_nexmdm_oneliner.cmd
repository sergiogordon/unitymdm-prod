@echo off & setlocal enabledelayedexpansion & set PKG=com.nexmdm & set ALIAS=test & set APK_PATH=%TEMP%\nexmdm-latest.apk & set BASE_URL=https://83b071bb-c5cb-4eda-b79c-d276873904c2-00-2ha4ytvejclnm.worf.replit.dev & set DL_URL=%BASE_URL%/v1/apk/download-latest & set ADMIN_KEY=YOUR_ADMIN_KEY_HERE & set MIN_SDK=30 & echo [NexMDM - Device: %ALIAS%] & echo. & echo [Step 0] Checking ADB... & where adb >nul 2>&1 || (echo X ADB not found in PATH & exit /b 1) & echo OK ADB found & echo. & echo [Step 1/8] Waiting for device... & adb wait-for-device || (echo X No device & exit /b 2) & echo OK Device connected & echo. & echo [Step 2/8] Checking Android version... & for /f "tokens=*" %%A in ('adb shell getprop ro.build.version.sdk 2^>nul') do set DEVICE_SDK=%%A & set DEVICE_SDK=!DEVICE_SDK: =! & for /f "tokens=*" %%A in ('adb shell getprop ro.build.version.release 2^>nul') do set DEVICE_VER=%%A & echo Device: Android !DEVICE_VER! (SDK !DEVICE_SDK!), Required: SDK %MIN_SDK%+ & if !DEVICE_SDK! LSS %MIN_SDK% (echo X INCOMPATIBLE - Requires Android 11+ & exit /b 2) & echo OK Version compatible & echo. & echo [Step 3/8] Downloading APK... & curl -L -H "X-Admin-Key: %ADMIN_KEY%" "%DL_URL%" -o "%APK_PATH%" 2>&1 || (echo X Download failed & exit /b 3) & if not exist "%APK_PATH%" (echo X APK missing & exit /b 3) & echo OK APK downloaded & echo. & echo [Step 4/8] Installing APK... & adb install -r -g "%APK_PATH%" 2>&1 & if errorlevel 1 (adb uninstall %PKG% >nul 2>&1 & adb install -r -g -t "%APK_PATH%" 2>&1 || (echo X Install failed & exit /b 4)) & echo OK APK installed & echo. & echo [Step 5/8] Setting Device Owner... & adb shell dpm set-device-owner %PKG%/.NexDeviceAdminReceiver 2>&1 & adb shell dumpsys device_policy | findstr /C:"%PKG%" >nul || (echo X Device Owner failed - Factory reset required & exit /b 5) & echo OK Device Owner confirmed & echo. & echo [Step 6/8] Permissions... & adb shell pm grant %PKG% android.permission.POST_NOTIFICATIONS 2>nul & adb shell pm grant %PKG% android.permission.CAMERA 2>nul & adb shell pm grant %PKG% android.permission.ACCESS_FINE_LOCATION 2>nul & adb shell appops set %PKG% RUN_ANY_IN_BACKGROUND allow 2>nul & adb shell appops set %PKG% GET_USAGE_STATS allow 2>nul & adb shell dumpsys deviceidle whitelist +%PKG% >nul & echo OK Permissions set & echo. & echo [Step 7/8] Optimizations... & adb shell "settings put global app_standby_enabled 0; settings put global adaptive_battery_management_enabled 0" >nul 2>&1 & echo OK Optimized & echo. & echo [Step 8/8] Configure... & adb shell monkey -p %PKG% -c android.intent.category.LAUNCHER 1 >nul 2>nul & timeout /t 2 /nobreak >nul & adb shell am broadcast --receiver-foreground -a %PKG%.CONFIGURE -n %PKG%/.ConfigReceiver --es server_url "%BASE_URL%" --es token "%ADMIN_KEY%" --es alias "%ALIAS%" & timeout /t 3 /nobreak >nul & adb shell pidof %PKG% >nul && (echo OK Service running) || (echo ! Service not detected yet) & echo. & echo ========================================== & echo OK ENROLLMENT COMPLETE & echo ========================================== & echo Device "%ALIAS%" - Android !DEVICE_VER! (SDK !DEVICE_SDK!) & echo Should appear in dashboard within ~60s & echo. & endlocal & exit /b 0

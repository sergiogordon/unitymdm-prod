@echo off & setlocal enabledelayedexpansion & set PKG=com.nexmdm & set ALIAS=test & set SPEEDTEST_PKG=com.unitynetwork.unityapp & set APK_PATH=%TEMP%\nexmdm-latest.apk & set BASE_URL=https://83b071bb-c5cb-4eda-b79c-d276873904c2-00-2ha4ytvejclnm.worf.replit.dev & set DL_URL=%BASE_URL%/v1/apk/download-latest & set ADMIN_KEY=YOUR_ADMIN_KEY_HERE & echo [NexMDM Deployment - Device: %ALIAS%] & echo. & echo [Step 0] Waiting for device... & adb wait-for-device || (echo ‚ùå No device found & exit /b 2) & echo [Step 1/7] Downloading latest APK... & curl -L -H "X-Admin-Key: %ADMIN_KEY%" "%DL_URL%" -o "%APK_PATH%" || (echo ‚ùå Download failed & exit /b 3) & if not exist "%APK_PATH%" (echo ‚ùå APK missing & exit /b 3) & echo ‚úÖ APK downloaded! & echo. & echo [Step 2/7] Installing APK... & adb install -r "%APK_PATH%" & if errorlevel 1 (adb shell pm uninstall -k --user 0 %PKG% 1>nul 2>nul & adb install -t -d "%APK_PATH%" || (echo ‚ùå Clean install failed & exit /b 4)) & echo ‚úÖ APK installed! & echo. & echo [Step 3/7] Ensuring Device Owner... & for /f "tokens=2 delims=: " %%A in ('adb shell settings get secure device_provisioned') do set DEVPROV=%%A & for /f "tokens=2 delims=: " %%B in ('adb shell settings get secure user_setup_complete') do set USERSETUP=%%B & set DEVPROV=!DEVPROV:~0,1! & set USERSETUP=!USERSETUP:~0,1! & adb shell dumpsys device_policy | findstr /C:"Device Owner" /C:"%PKG%" >nul & if errorlevel 1 (if "!DEVPROV!"=="1" if "!USERSETUP!"=="1" (echo ‚ùå Cannot set DO on provisioned device. Factory reset required. & exit /b 5) & adb shell dpm set-device-owner %PKG%/.NexDeviceAdminReceiver 1>nul 2>nul || (echo ‚ùå Failed to set Device Owner & exit /b 6)) & echo ‚úÖ Device Owner confirmed. & echo. & echo [Step 4/7] Permissions... & adb shell pm grant %PKG% android.permission.POST_NOTIFICATIONS 2>nul & adb shell pm grant %PKG% android.permission.CAMERA 2>nul & adb shell pm grant %PKG% android.permission.ACCESS_FINE_LOCATION 2>nul & adb shell appops set %PKG% RUN_ANY_IN_BACKGROUND allow 2>nul & adb shell appops set %PKG% AUTO_REVOKE_PERMISSIONS_IF_UNUSED ignore 2>nul & adb shell appops set %PKG% GET_USAGE_STATS allow 2>nul & adb shell dumpsys deviceidle whitelist +%PKG% 1>nul & echo ‚úÖ Permissions set! & echo. & echo [Step 5/7] Optimizations... & adb shell "settings put global app_standby_enabled 0; settings put global adaptive_battery_management_enabled 0" 1>nul 2>nul & adb shell cmd deviceidle whitelist +%SPEEDTEST_PKG% 1>nul 2>&1 & echo ‚úÖ Optimized! & echo. & echo [Step 6/7] Configure... & adb shell monkey -p %PKG% -c android.intent.category.LAUNCHER 1 1>nul 2>nul & timeout /t 2 /nobreak >nul & adb shell am broadcast --receiver-foreground -a %PKG%.CONFIGURE -n %PKG%/.ConfigReceiver --es server_url "%BASE_URL%" --es token "%ADMIN_KEY%" --es alias "%ALIAS%" & timeout /t 3 /nobreak >nul & echo ‚úÖ Configured! & echo. & echo [Step 7/7] Verify... & adb shell pidof %PKG% 1>nul && (echo ‚úÖ Service running) || (echo ‚ùå Service not running & exit /b 9) & echo. & echo ========================================== & echo ‚úÖ ENROLLMENT COMPLETE & echo ========================================== & echo üì± "%ALIAS%" should appear in dashboard within ~60s. & echo. & echo NOTE: For best results, use the ADB Setup page in your dashboard. & endlocal & exit /b 0
